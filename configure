#!/usr/bin/env sh
set -eu

# defaults (override possible)
CC=${CC:-cc}
CFLAGS=${CFLAGS:-"-O2 -Wall -Wextra -pedantic -std=c11 -Iinclude -Isrc"}
LDFLAGS=${LDFLAGS:-""}
PREFIX=${PREFIX:-"/usr/local"}

# allow: ./configure --prefix=/opt/foo
for arg in "$@"; do
  case "$arg" in
    --prefix=*)
      PREFIX="${arg#*=}"
      ;;
    *)
      echo "Unknown option: $arg" >&2
      echo "Usage: ./configure [--prefix=PATH]" >&2
      exit 2
      ;;
  esac
done

# sanity checks
if [ ! -f "Makefile" ]; then
  echo "Error: Makefile not found in repository root." >&2
  exit 1
fi

if [ ! -f "src/sample_main.c" ]; then
  echo "Error: src/sample_main.c not found." >&2
  echo "Tip: adjust SRCS in Makefile or rename accordingly." >&2
  exit 1
fi

# optional header checks (adjust if your header lives elsewhere)
if [ ! -f "sample.h" ] && [ ! -f "include/sample.h" ] && [ ! -f "src/sample.h" ]; then
  echo "Warning: sample.h not found in root/include/src. (Continuing)" >&2
fi

# write config for Makefile to include
cat > config.mk <<EOF
# Generated by ./configure
CC      := ${CC}
CFLAGS  := ${CFLAGS}
LDFLAGS := ${LDFLAGS}
PREFIX  := ${PREFIX}
EOF

echo "Configuration complete. Wrote config.mk"
echo "Now run: make"